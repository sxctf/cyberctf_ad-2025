<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>BioForge Playground</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <link
            href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&family=Inter:wght@400;500;600&display=swap"
            rel="stylesheet"
        />
        <link rel="stylesheet" href="style.css" />

        <style>
            body {
                display: flex;
            }
            .sidebar {
                width: 200px;
                background: #111;
                color: #e5e7eb;
                padding: 12px;
                border-right: 1px solid #333;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
            }
            .sidebar h3 {
                font-size: 14px;
                margin-top: 0;
            }
            .sidebar input {
                width: 100%;
                padding: 8px;
                margin-bottom: 8px;
                background: #222;
                color: #e5e7eb;
                border: 1px solid #333;
                border-radius: 4px;
            }
            .sidebar button {
                width: 100%;
                padding: 8px;
                margin-bottom: 8px;
                background: #e50914;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }
            .sidebar button:hover {
                background: #ff3344;
            }
            .sidebar ul {
                list-style: none;
                padding: 0;
                max-height: 200px;
                overflow-y: auto;
            }
            .sidebar li {
                cursor: pointer;
                padding: 4px;
                border-bottom: 1px solid #333;
            }
            .sidebar li:hover {
                background: #222;
            }
            .sidebar .version {
                text-align: center;
                font-size: 12px;
                color: #888;
                margin-top: 10px;
            }
            .main-area {
                flex: 1;
                padding: 20px;
            }
            .section-head {
                display: flex;
                justify-content: space-between;
                align-items: baseline;
                margin-bottom: 10px;
            }
            .btn-group-header {
                display: flex;
                gap: 10px;
            }
            .version {
                margin-bottom: 10px;
            }
            #modal {
                display: none;
                position: fixed;
                top: 10%;
                left: 10%;
                width: 80%;
                max-height: 80vh;
                background: #111;
                padding: 20px;
                border: 2px solid #e50914;
                border-radius: 8px;
                color: #e5e7eb;
                z-index: 1000;
                overflow: auto;
                box-sizing: border-box;
            }
            #modal pre {
                white-space: pre-wrap;
                word-wrap: break-word;
                overflow-x: auto;
                max-height: 60vh;
                margin-bottom: 10px;
            }
            #modal button {
                display: block;
                margin: 10px auto 0;
                padding: 8px 16px;
                background: #e50914;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }
            #modal button:hover {
                background: #ff3344;
            }
            #notificationModal {
                display: none;
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 90%;
                max-width: 500px;
                max-height: 80vh;
                background: #111;
                padding: 20px;
                border: 2px solid #e50914;
                border-radius: 8px;
                color: #e5e7eb;
                z-index: 1001;
                box-sizing: border-box;
                text-align: center;
            }
            #notificationModal.success {
                border-color: #4caf50;
            }
            #notificationModal.error {
                border-color: #f44336;
            }
            #notificationModal.warning {
                border-color: #ff9800;
            }
            #notification-content {
                margin-bottom: 15px;
                font-size: 16px;
                white-space: pre-wrap;
                word-wrap: break-word;
            }
            #notificationModal button {
                display: inline-block;
                padding: 8px 16px;
                background: #e50914;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }
            #notificationModal button:hover {
                background: #ff3344;
            }
            #loadingModal {
                display: none;
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 300px;
                background: #111;
                padding: 40px;
                border: 2px solid #e50914;
                border-radius: 8px;
                color: #e5e7eb;
                z-index: 1002;
                text-align: center;
                font-size: 24px;
            }
            #loadingModal .spinner {
                border: 8px solid #f3f3f3;
                border-top: 8px solid #e50914;
                border-radius: 50%;
                width: 60px;
                height: 60px;
                animation: spin 2s linear infinite;
                margin: 0 auto 20px;
            }
            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }
        </style>
    </head>
    <body>
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div>
                <h3>Search Results</h3>
                <input
                    type="text"
                    id="idSearch"
                    placeholder="Enter ID to load"
                />
                <button id="loadSearch">Load</button>
                <ul id="resultsList"></ul>
            </div>
            <div class="version">v.0.0.1 By BioForge</div>
        </div>

        <!-- Main -->
        <div class="main-area">
            <div class="section-head">
                <h2 class="section-title">GenLang Editor</h2>
                <div class="btn-group-header">
                    <button
                        class="btn btn-outline"
                        onclick="location.href='index.html'"
                    >
                        Back
                    </button>
                    <button
                        class="btn btn-outline"
                        onclick="location.href='docs.html'"
                    >
                        Documentation
                    </button>
                </div>
            </div>
            <textarea
                id="code"
                class="textarea"
                rows="14"
                style="white-space: pre-wrap"
            >
express("BioForge Online");</textarea
            >

            <div class="row" style="margin-top: 14px">
                <button id="run" class="btn btn-primary">Execute</button>
                <button id="save" class="btn btn-outline">Save Output</button>
                <button id="clear" class="btn btn-outline">Clear Output</button>
                <span id="status" class="helper"></span>
            </div>

            <h2 class="section-title" style="margin-top: 20px">Output</h2>
            <textarea
                readonly
                id="out"
                class="textarea"
                style="
                    background: #000;
                    color: #0f0;
                    min-height: 220px;
                    overflow: auto;
                    white-space: pre-wrap;
                "
            ></textarea>
        </div>

        <!-- Results Modal -->
        <div id="modal">
            <pre id="modal-content"></pre>
            <button
                onclick="document.getElementById('modal').style.display='none'"
            >
                Close
            </button>
        </div>

        <!-- Notification Modal -->
        <div id="notificationModal">
            <div id="notification-content"></div>
            <button
                onclick="document.getElementById('notificationModal').style.display='none'"
            >
                Close
            </button>
        </div>

        <!-- Loading Modal -->
        <div id="loadingModal">
            <div class="spinner"></div>
            <div>Loading...</div>
        </div>

        <script>
            let myIds;
            try {
                myIds = JSON.parse(localStorage.getItem("myIds")) || [];
            } catch (e) {
                console.error("Invalid myIds in localStorage:", e);
                myIds = [];
                localStorage.setItem("myIds", JSON.stringify(myIds));
            }

            const runBtn = document.getElementById("run");
            const saveBtn = document.getElementById("save");
            const outEl = document.getElementById("out");
            const status = document.getElementById("status");
            const loadingModal = document.getElementById("loadingModal");

            function showLoading() {
                loadingModal.style.display = "block";
            }
            function hideLoading() {
                loadingModal.style.display = "none";
            }
            function updateStatus(message, type = "idle") {
                status.textContent = message;
                status.style.color =
                    type === "success"
                        ? "lime"
                        : type === "error"
                          ? "red"
                          : "gray";
            }
            function showNotification(message, type = "info") {
                const modal = document.getElementById("notificationModal");
                const content = document.getElementById("notification-content");
                content.textContent = message;
                modal.className = type;
                modal.style.display = "block";
            }

            document.getElementById("loadSearch").onclick = () => {
                const id = document.getElementById("idSearch").value.trim();
                if (!id) {
                    showNotification("Please enter an ID", "warning");
                    return;
                }
                loadResult(id);
            };
            document
                .getElementById("idSearch")
                .addEventListener("keypress", (e) => {
                    if (e.key === "Enter") {
                        document.getElementById("loadSearch").click();
                    }
                });

            runBtn.onclick = async () => {
                console.log("Executing code...");
                runBtn.disabled = true;
                showLoading();
                outEl.textContent = "";
                try {
                    const res = await fetch("/api/execute", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            code: document.getElementById("code").value,
                        }),
                    });
                    const data = await res.json();
                    outEl.textContent =
                        data.result || data.error || JSON.stringify(data);
                } catch (e) {
                    outEl.textContent = "Error: " + (e.message || e);
                } finally {
                    hideLoading();
                    runBtn.disabled = false;
                }
            };

            function debounce(func, delay) {
                let timeoutId;
                return function (...args) {
                    if (timeoutId) clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => func.apply(this, args), delay);
                };
            }

            saveBtn.onclick = debounce(async () => {
                const result = outEl.textContent.trim();
                if (!result) {
                    showNotification("Nothing to save!", "warning");
                    return;
                }
                saveBtn.disabled = true;
                showLoading();
                try {
                    const id = Date.now();
                    const res = await fetch("/api/save", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ id, result }),
                    });
                    const data = await res.json();
                    showNotification("Saved with ID: " + data.id, "success");
                    myIds.push(data.id);
                    localStorage.setItem("myIds", JSON.stringify(myIds));
                    renderIds();
                } catch (e) {
                    showNotification(
                        "Save error: " + (e.message || e),
                        "error",
                    );
                } finally {
                    hideLoading();
                    saveBtn.disabled = false;
                }
            }, 1000);

            document.getElementById("clear").onclick = () =>
                (outEl.textContent = "");

            function renderIds() {
                const list = document.getElementById("resultsList");
                list.innerHTML = "";
                myIds.forEach((id) => {
                    const li = document.createElement("li");
                    li.textContent = id;
                    li.onclick = () => loadResult(id);
                    list.appendChild(li);
                });
            }

            async function loadResult(id) {
                try {
                    const res = await fetch(`/api/results/${id}`, {
                        headers: { "Content-Type": "application/json" },
                    });
                    const data = await res.json();
                    document.getElementById("modal-content").textContent =
                        JSON.stringify(data, null, 2);
                    document.getElementById("modal").style.display = "block";
                } catch (e) {
                    showNotification(
                        "Load error: " + (e.message || e),
                        "error",
                    );
                }
            }

            renderIds();
        </script>
    </body>
</html>
